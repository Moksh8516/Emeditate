name: Deploy to Firebase App Hosting

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # ✅ 1. Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # ✅ 2. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ✅ 3. Install dependencies
      - name: Install dependencies
        run: npm ci

      # ✅ 4. Copy Firebase config for production build
      - name: Use Firebase Next.js config
        run: cp next.config.firebase.ts next.config.ts

      # ✅ 5. Install Firebase CLI
      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      # ✅ 6. Authenticate Firebase
      - name: Authenticate Firebase
        run: firebase login:ci --token "${{ secrets.FIREBASE_TOKEN }}"

      # ✅ 7. Sync GitHub Secrets → Firebase App Hosting Secrets
      - name: Set App Hosting Secrets
        run: |
          firebase apphosting:secrets:set NEXT_PUBLIC_API_URL --backend=emeditate --project=sita-newseekerapp-2020 --value="${{ secrets.NEXT_PUBLIC_API_URL }}"
          firebase apphosting:secrets:set NEXT_PUBLIC_FIREBASE_API_KEY --backend=emeditate --project=sita-newseekerapp-2020 --value="${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}"
          firebase apphosting:secrets:set NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN --backend=emeditate --project=sita-newseekerapp-2020 --value="${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}"
          firebase apphosting:secrets:set NEXT_PUBLIC_FIREBASE_PROJECT_ID --backend=emeditate --project=sita-newseekerapp-2020 --value="${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}"
          firebase apphosting:secrets:set NEXT_PUBLIC_FIREBASE_APP_ID --backend=emeditate --project=sita-newseekerapp-2020 --value="${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}"
          firebase apphosting:secrets:set JWT_SECRET --backend=emeditate --project=sita-newseekerapp-2020 --value="${{ secrets.JWT_SECRET }}"

      # ✅ 8. Build Next.js app
      - name: Build Next.js project
        run: npm run build

      # ✅ 9. Deploy to Firebase App Hosting
      - name: Deploy to Firebase App Hosting
        run: firebase deploy --only apphosting --project=sita-newseekerapp-2020
